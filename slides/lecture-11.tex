\newcommand{\h}{%
handout,%
}

\input{preamble.tex}

\title[Уровень микроархитектуры (1)]{Архитектура компьютеров\texorpdfstring{\\}{ }Лекция 11. Уровень микроархитектуры:
микропрограммное управление}

\begin{document}

\begin{frame}
\titlepage
\end{frame}

\begin{frame}{Современные многоуровневые машины}
\screenshotw{6cm}{multi-level-computer.pdf}
\end{frame}

\begin{frame}
\frametitle{Содержание}
\tableofcontents[hideallsubsections]
\end{frame}

\section[Mic-1]{Учебная микроархитектура Mic-1}
\subsection{Арифметико-логическое устройство}

\begin{frame}[plain]
\frametitle{Одноразрядная секция АЛУ}
\begin{columns}

        \column{3.5cm}\onslide<2>{
    Номера команд:
    \begin{itemize}
        \item 0 — A \textbf{AND} B
        \item 1 — \textbf{NOT} B
        \item 2 — A \textbf{OR} B
        \item 3 — A \textbf{+} B
    \end{itemize}}

        \column{9cm}
    \screenshotw{9cm}{1-ALU.png}
\end{columns}
\end{frame}


\begin{frame}
\frametitle{Полезные сочетания управляющих входов АЛУ}
\begin{columns}

        \column{3.5cm}
    Номера команд:
    \begin{itemize}
        \item 0 — A \textbf{AND} B
        \item 1 — \textbf{NOT} B
        \item 2 — A \textbf{OR} B
        \item 3 — A \textbf{+} B
    \end{itemize}

        %\pause
        \column{9cm}
    \vspace{-.3cm}\screenshotw{7cm}{alu-table.png}
\end{columns}
\end{frame}

\subsection{Тракт данных}
\begin{frame}[plain]
\frametitle{Тракт данных Mic-1}
    \vspace{-.2cm}\screenshotw{5.7cm}{datapath.pdf}
\end{frame}


\begin{frame}
\frametitle{Синхронизация тракта данных Mic-1}
\begin{columns}
        \column{4cm}
    \screenshotw{3.5cm}{datapath-light.pdf}

        \column{9cm}
    \screenshotw{8.7cm}{datapath-timing-crpd-c1.png}

\end{columns}
\end{frame}

\begin{frame}{Связь с оперативной памятью}

\footnotesize
\begin{columns}
        \column{4cm}
    \onslide<1->{\screenshotw{3.5cm}{datapath-light.pdf}}

        \column{9cm}
\onslide<2->{\begin{itemize}
    \item Регистры для данных:
        \begin{itemize}\footnotesize
            \item MDR (Memory Data Register) — 32-bit wide,
            \item MAR (Memory Address Register) — word-oriented, 32-bit wide.
        \end{itemize}
\end{itemize}}

\onslide<3->{\screenshotw{8cm}{MAR-to-bus.png}}

\onslide<4->{\begin{itemize}
    \item Регистры для инструкций:
        \begin{itemize}\footnotesize
            \item PC (Program Counter) — byte-oriented, 32-bit wide,
            \item MBR (Memory Buffer Register) — 8-bit wide.
        \end{itemize}}

\onslide<5->{
\item Управляющие сигналы: rd / wr / fetch.
\end{itemize}}
\end{columns}

\end{frame}

\subsection{Микропрограммное управление}

\begin{frame}
\frametitle{Управляющие (командные) сигналы тракта данных}
\begin{columns}
        \column{4cm}
    %\vspace{-.9cm}
    \screenshotw{3.5cm}{datapath-light.pdf}

        \column{9cm}

\pause\begin{itemize}\small
    \item 9 сигналов для загрузки одного из регистров на шину B;
    \item 9 сигналов для записи в некоторые регистры значения с шины C;
    \item 8 сигналов для управления АЛУ и схемой сдвига;
    \item 2 сигнала: запись или чтение слова из памяти;
    \item 1 сигнал: необходимость загрузки (fetch) очередной команды.
\end{itemize}
\pause\color{blue}{Сколько всего управляющих сигналов?}\\
\pause\color{blue}{Можно ли сэкономить?}\\
\pause \color{red}{А давайте применим декодер!}
\end{columns}

\end{frame}

\begin{frame}
\frametitle{Формат микрокоманды (36 бит)}
\screenshotw{11cm}{microcommand.png}
\pause

Поля \texttt{JAM} и \texttt{NEXT\_ADDRESS} реализуют логику \\
    \alert{управления последовательностью микрокоманд}\\
    (\alert{sequencer}).
\end{frame}

\begin{frame}
\frametitle{Определение адреса следующей микрокоманды}

    Пример
    \screenshotw{12cm}{jamz.png}

    \pause
    В общем случае:

    \pause
    {\small \ttfamily
    MPC[0..7] = JMPC ? MBR : NEXT\_ADDRESS[0..7]}

    \pause
    {\small \ttfamily MPC[8] = ( JAMZ \& Z ) | ( JAMN \& N )
        | \color{gray}{NEXT\_ADDRESS[8]}}
\end{frame}

\subsection{Микроассемблер для Mic-1}

\begin{frame}{Микроассемблер MAC}
    \alert{Как удобно записывать микрокоманды?}\\
    {\small ReadReg = SP, ALU = INC, WSP, Read, NEXT\_ADDRESS = 122? \pause — Nope!}
    \pause

\begin{columns}
        \column{5cm}
    \begin{block}{Арифметика и память}
    \begin{itemize}
        \item \pause SP = SP + 1; rd
        \item \pause MDR = SP
        \item \pause MDR = H + SP
        \item \pause SP = MDR = SP + 1
        \item \pause MDR = SP + MDR \pause — нельзя!
        \item \pause некорректная пара:\\
            MAR = SP; rd \\
            MDR = H
    \end{itemize}
    \end{block}

        \column{6.5cm}
    %\vspace{.5cm}
    \pause \begin{block}{Переходы}
    \begin{itemize}
        \item \pause goto \textit{label}
        \item \pause учёт флагов Z/N:\\
            {\small Z = TOS ; if (Z) goto L1; else goto L2}
        \item \pause goto (MBR)
    \end{itemize}
    \end{block}

\end{columns}
\end{frame}

\begin{frame}[plain]
\frametitle{Микроархитектура Mic-1}
\vspace{-.3cm}
\screenshotw{8.5cm}{Mic-1.png}
\end{frame}

\section[IJVM]{Набор инструкций IJVM и его реализация на Mic-1}

\begin{frame}{Стековые машины}

    \pause
    %\begin{block}{%
    Стек кадров подпрограмм:
    %}
    \screenshotw{11cm}{stacks.png}
    %\end{block}
    \pause

    %\begin{block}{
    Стек операндов, пример: a1 = a2 + a3:
    %}
    \pause\screenshotw{11cm}{operand-stack.png}
    %\end{block}

    \pause
    \vspace{-.2cm}{\small Стековые машины vs. регистровые машины.}
\end{frame}

%\begin{frame}{Модель памяти IJVM}
%    \screenshotw{11cm}{ijvm-memory-model.png}
%\end{frame}

%\begin{frame}{Набор инструкций IJVM}
%\screenshotw{8.5cm}{ijvm-is.png}
%\end{frame}

\begin{frame}{Компиляция в IJVM}
\screenshotw{11cm}{ijvm-compile.png}
\end{frame}

\begin{frame}{Примеры микропрограммных реализаций инструкций}
    \ttfamily\small

\pause
    Main1: PC = PC + 1; fetch; goto (MBR)

\begin{columns}
        \column{5.5cm}

    \pause
    \begin{block}{\texttt{IADD (0x60)}}
    \begin{enumerate}
        \item MAR = SP = SP — 1; rd
        \item H = TOS
        \item MDR = TOS = H + MDR; wr; goto Main1
    \end{enumerate}
    \end{block}

        \column{5.5cm}
    \pause
    \begin{block}{\texttt{ILOAD k}}
    \begin{enumerate}
        \item H = LV
        \item MAR = MBRU + H; rd
        \item MAR = SP = SP + 1
        \item PC = PC + 1; fetch; wr
        \item TOS = MDR; goto Main1
    \end{enumerate}
    \end{block}

\end{columns}
\end{frame}

\begin{frame}{О наборе инструкций IJVM и \link{http://mmcs.sfedu.ru/~ulysses/Edu/CS221/mic1ijvm-mmcs.mal}{его реализации на Mic-1}}

\begin{columns}
        \column{4cm}
    \screenshotw{3.5cm}{datapath-light.pdf}

        \column{9cm}
\screenshotw{8.5cm}{ijvm-is.png}

\end{columns}
\end{frame}

\end{document}

